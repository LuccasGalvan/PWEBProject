@page "/historico-compras"
@using RCLAPI.DTO
@using RCLAPI.Services
@inject IApiServices ApiServices
@inject IJSRuntime JSRuntime

<h3>Histórico de Compras</h3>

@if (isLoading)
{
    <p>Carregando o histórico de compras...</p>
}
else if (string.IsNullOrWhiteSpace(userId))
{
    <p>Inicie sessão para consultar o histórico de compras.</p>
}
else if (encomendas == null || !encomendas.Any())
{
    <p>Não há encomendas registadas.</p>
}
else
{
    <div class="orders">
        @foreach (var encomenda in encomendas)
        {
            <section class="order-card">
                <header class="order-header">
                    <div>
                        <div class="order-id">Encomenda #@encomenda.Id</div>
                        <div class="order-meta">@FormatDate(encomenda.CriadaEmUtc)</div>
                    </div>
                    <div class="order-status @GetStatusClass(encomenda.Estado)">
                        @GetStatusLabel(encomenda.Estado)
                    </div>
                    <div class="order-total">Total: @encomenda.Total.ToString("C")</div>
                </header>
                <div class="order-items">
                    <table>
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Preço Unitário</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in encomenda.Itens)
                            {
                                <tr>
                                    <td>
                                        <div class="product-cell">
                                            @if (!string.IsNullOrWhiteSpace(GetProdutoImagem(item.Produto)))
                                            {
                                                <img src="@GetProdutoImagem(item.Produto)" alt="@item.Produto?.Nome" />
                                            }
                                            <span>@(item.Produto?.Nome ?? $"Produto #{item.ProdutoId}")</span>
                                        </div>
                                    </td>
                                    <td>@item.Quantidade</td>
                                    <td>@item.PrecoUnitario.ToString("C")</td>
                                    <td>@item.Subtotal.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </section>
        }
    </div>
}

@code {
    private List<Encomenda>? encomendas;
    private string? userId;
    private bool isLoading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            userId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userID");

            if (!string.IsNullOrWhiteSpace(userId))
            {
                encomendas = await ApiServices.ObterEncomendas(userId);
            }

            isLoading = false;
            StateHasChanged();
        }
    }

    private static string FormatDate(DateTime date)
    {
        var localDate = date.Kind == DateTimeKind.Utc ? date.ToLocalTime() : date;
        return localDate.ToString("dd/MM/yyyy HH:mm");
    }

    private static string GetStatusLabel(EncomendaEstado estado)
    {
        return estado switch
        {
            EncomendaEstado.PendentePagamento => "Pendente de pagamento",
            EncomendaEstado.Paga => "Paga",
            EncomendaEstado.Confirmada => "Confirmada",
            EncomendaEstado.Rejeitada => "Rejeitada",
            EncomendaEstado.Expedida => "Expedida",
            _ => "Desconhecida"
        };
    }

    private static string GetStatusClass(EncomendaEstado estado)
    {
        return estado switch
        {
            EncomendaEstado.PendentePagamento => "status-pendente",
            EncomendaEstado.Paga => "status-paga",
            EncomendaEstado.Confirmada => "status-confirmada",
            EncomendaEstado.Rejeitada => "status-rejeitada",
            EncomendaEstado.Expedida => "status-expedida",
            _ => ""
        };
    }

    private static string? GetProdutoImagem(ProdutoDTO? produto)
    {
        if (produto?.Imagem is { Length: > 0 })
        {
            return $"data:image/png;base64,{Convert.ToBase64String(produto.Imagem)}";
        }

        return string.IsNullOrWhiteSpace(produto?.UrlImagem) ? null : produto.UrlImagem;
    }
}
