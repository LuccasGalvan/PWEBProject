@page "/encomenda/edit"
@attribute [Authorize(Roles = "Admin,Gestor")]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Data
@using GestaoLoja.Entity
@using GestaoLoja.Entity.Enums
@using GestaoLoja.Services

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject EncomendaWorkflowService WorkflowService

<PageTitle>Editar Encomenda</PageTitle>

<h1>Editar Encomenda</h1>

@if (notFound)
{
    <p><em>Not found.</em></p>
}
else if (!loaded)
{
    <p><em>Loading...</em></p>
}
else
{
    <h2>Encomenda</h2>
    <hr />

    <div class="row">
        <div class="col-md-4">
            <EditForm method="post"
                      Model="@Action"
                      OnValidSubmit="@UpdateEncomenda"
                      FormName="editEncomenda"
                      Enhance>
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <@InputHidden @bind-Value="Action.EncomendaId" />
                <@InputHidden @bind-Value="Action.TargetEstado" />

                <div class="mb-3">
                    <label class="form-label">Id</label>
                    <InputText class="form-control" Value="@Encomenda.Id.ToString()" disabled />
                </div>

                <div class="mb-3">
                    <label class="form-label">ClienteId</label>
                    @* show only, never editable *@
                    <InputText class="form-control" Value="@Encomenda.ClienteId" disabled />
                </div>

                <div class="mb-3">
                    <label class="form-label">Estado</label>
                    <InputText class="form-control" Value="@Encomenda.Estado" disabled />
                </div>

                <div class="mb-3">
                    <label class="form-label">Total</label>
                    <InputNumber class="form-control" Value="@Encomenda.Total" disabled />
                </div>

                @if (!string.IsNullOrWhiteSpace(actionError))
                {
                    <div class="alert alert-danger" role="alert">@actionError</div>
                }

                <div class="d-flex flex-wrap gap-2">
                    <button type="submit"
                            class="btn btn-success"
                            @onclick="() => Action.TargetEstado = EncomendaEstado.Confirmada"
                            disabled="@(!CanConfirm || isUpdating)">
                        Confirmar
                    </button>
                    <button type="submit"
                            class="btn btn-danger"
                            @onclick="() => Action.TargetEstado = EncomendaEstado.Rejeitada"
                            disabled="@(!CanReject || isUpdating)">
                        Rejeitar
                    </button>
                    <button type="submit"
                            class="btn btn-primary"
                            @onclick="() => Action.TargetEstado = EncomendaEstado.Expedida"
                            disabled="@(!CanShip || isUpdating)">
                        Expedir
                    </button>
                    <a class="btn btn-secondary ms-2" href="/encomenda">Back to List</a>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    private Guid Id { get; set; }

    [SupplyParameterFromForm]
    private EncomendaAction Action { get; set; } = new();

    private Encomenda? Encomenda { get; set; }
    private string? actionError;
    private bool isUpdating;
    private bool loaded;
    private bool notFound;

    private bool CanConfirm => Encomenda is not null
        && WorkflowService.CanTransition(Encomenda.Estado, EncomendaEstado.Confirmada);
    private bool CanReject => Encomenda is not null
        && WorkflowService.CanTransition(Encomenda.Estado, EncomendaEstado.Rejeitada);
    private bool CanShip => Encomenda is not null
        && WorkflowService.CanTransition(Encomenda.Estado, EncomendaEstado.Expedida);

    protected override async Task OnInitializedAsync()
    {
        await LoadEncomendaAsync();
    }

    private async Task LoadEncomendaAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        Encomenda = await db.Encomendas
            .AsNoTracking()
            .FirstOrDefaultAsync(e => e.Id == Id);

        if (Encomenda is null)
        {
            notFound = true;
            loaded = true;
            return;
        }

        if (Action.EncomendaId == Guid.Empty)
        {
            Action.EncomendaId = Encomenda.Id;
        }

        if (!Enum.IsDefined(typeof(EncomendaEstado), Action.TargetEstado))
        {
            Action.TargetEstado = Encomenda.Estado;
        }

        loaded = true;
    }

    private async Task UpdateEncomenda()
    {
        if (Encomenda is null)
            return;

        isUpdating = true;
        actionError = null;

        var result = await WorkflowService.TryTransitionAsync(Id, Action.TargetEstado);
        if (!result.Success)
        {
            actionError = result.ErrorMessage ?? "Transição inválida.";
        }

        await LoadEncomendaAsync();
        isUpdating = false;
    }

    private sealed class EncomendaAction
    {
        public Guid EncomendaId { get; set; }
        public EncomendaEstado TargetEstado { get; set; }
    }
}
