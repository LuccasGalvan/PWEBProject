@page "/sobre"
@using RCLAPI.Services
@using RCLAPI.DTO
@using Microsoft.AspNetCore.Components.Forms
@inject AuthService _authService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<h3>Informações do Utilizador</h3>

@if (user != null)
{
    <div>
        @if(erro == true){
            <p>"Ocorreu um erro ao gravar as alterações"</p>
        }
        <div>
            <label for="nome"><strong>Nome:</strong></label>
            @if (_isEditing)
            {
                <input id="nome" @bind="user.Nome" />
            }
            else
            {
                <p>@(string.IsNullOrEmpty(user.Nome) ? "Não disponível" : user.Nome)</p>
            }
        </div>

        <div>
            <label for="apelido"><strong>Apelido:</strong></label>
            @if (_isEditing)
            {
                <input id="apelido" @bind="user.Apelido" />
            }
            else
            {
                <p>@(string.IsNullOrEmpty(user.Apelido) ? "Não disponível" : user.Apelido)</p>
            }
        </div>

        <div>
            <label for="email"><strong>Email:</strong></label>
            @if (_isEditing)
            {
                <input id="email" @bind="user.EMail" />
            }
            else
            {
                <p>@(string.IsNullOrEmpty(user.EMail) ? "Não disponível" : user.EMail)</p>
            }
        </div>

        <div>
            <label for="nif"><strong>NIF:</strong></label>
            @if (_isEditing)
            {
                <input id="nif" @bind="user.NIF" />
            }
            else
            {
                <p> @(user.NIF == 0 ? "Não disponível" : user.NIF.ToString())</p>
            }
        </div>

        <div>
            <label for="rua"><strong>Rua:</strong></label>
            @if (_isEditing)
            {
                <input id="rua" @bind="user.Rua" />
            }
            else
            {
                <p>@(string.IsNullOrEmpty(user.Rua) ? "Não disponível" : user.Rua)</p>
            }
        </div>

        <div>
            <label for="localidade1"><strong>Localidade 1:</strong></label>
            @if (_isEditing)
            {
                <input id="localidade1" @bind="user.Localidade1" />
            }
            else
            {
                <p>@(string.IsNullOrEmpty(user.Localidade1) ? "Não disponível" : user.Localidade1)</p>
            }
        </div>

        <div>
            <label for="localidade2"><strong>Localidade 2:</strong></label>
            @if (_isEditing)
            {
                <input id="localidade2" @bind="user.Localidade2" />
            }
            else
            {
                <p>@(string.IsNullOrEmpty(user.Localidade2) ? "Não disponível" : user.Localidade2)</p>
            }
        </div>

        <div>
            <label for="pais"><strong>País:</strong></label>
            @if (_isEditing)
            {
                <input id="pais" @bind="user.Pais" />
            }
            else
            {
                <p>@(string.IsNullOrEmpty(user.Pais) ? "Não disponível" : user.Pais)</p>
            }
        </div>

        @if (_isEditing)
        {
            <button @onclick="Gravar">Guardar</button>
            <button @onclick="Editing">Cancelar</button>
        }else{
            <button @onclick="LogoutUser">Logout</button>
            <button @onclick="Editing">Editar</button>
        }
    </div>
}
else
{
    <p>utilizador não autenticado. Faça login primeiro.</p>
}

@code {
    private Utilizador? user;
    private bool _isInitialized = false;
    private bool _isEditing = false;
    private bool erro = false;
    private string? photoPreview;
    private InputFile? fileInput;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var userId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userID");

            if (!string.IsNullOrEmpty(userId))
            {
                var authenticatedUser = await _authService.GetUserInformation(userId);
                if (authenticatedUser != null)
                {
                    user = authenticatedUser;  
                    StateHasChanged();
                }
            }
            else
            {
                NavigationManager.NavigateTo("/modalogin");
            }

            _isInitialized = true;
        }
    }

    private async Task Editing() {
        if (_isEditing == true)
        {
            _isEditing = false;
        }
        else
        {
            _isEditing = true;
        }
    }

    private async Task Gravar()
    {
        _isEditing = false;

        // Preencher valores vazios ou nulos antes de enviar
        user.Nome = user.Nome ?? string.Empty;
        user.Apelido = user.Apelido ?? string.Empty;
        user.EMail = user.EMail ?? string.Empty;
        user.Rua = user.Rua ?? string.Empty;
        user.Localidade1 = user.Localidade1 ?? string.Empty;
        user.Localidade2 = user.Localidade2 ?? string.Empty;
        user.Pais = user.Pais ?? string.Empty;

        // Se a senha não for fornecida, use valores vazios
        user.Password = user.Password ?? string.Empty;
        user.ConfirmPassword = user.ConfirmPassword ?? string.Empty;

        var tf = await _authService.UpdateUserInformation(user);
        if (tf != true)
        {
            erro = true;
        }
	}

    private async Task LogoutUser()
    {
        await _authService.ClearUserAsync();
        user = null;

        StateHasChanged();

        NavigationManager.NavigateTo("/", true);
    }
}
